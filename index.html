<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>–°–æ–∑–¥–∞—Ç–µ–ª—å –∫–∞—Ä—É—Å–µ–ª–µ–π v2</title>

  <style>
    :root{
      --bg:#F8FAFC; --surface:#FFFFFF; --text:#0F172A; --muted:#64748B;
      --border:#E2E8F0; --primary:#2563EB; --primary-hover:#1D4ED8;
      --radius-lg:18px; --radius-md:12px; --shadow:0 6px 20px rgba(15,23,42,.08);
      --gray:#F1F5F9; --danger:#DC2626;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.6 -apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:32px 16px}
    header{text-align:center;margin-bottom:32px}
    h1{margin:0 0 12px;font-size:32px;font-weight:700}
    .sub{margin:0;color:var(--muted);font-size:18px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:24px;margin-bottom:24px}
    label{display:block;font-weight:600;margin-bottom:8px;font-size:16px}
    textarea,select,input[type=number]{width:100%;border-radius:var(--radius-md);border:1px solid var(--border);padding:12px 14px;font-size:16px;font-family:inherit;background:#fff;transition:border .2s ease}
    textarea{min-height:160px;resize:vertical}
    textarea:focus,select:focus,input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.25)}
    button{border:none;border-radius:var(--radius-md);font-size:16px;font-weight:600;padding:12px 18px;cursor:pointer;transition:background .2s}
    button.primary{background:var(--primary);color:#fff}
    button.primary:hover{background:var(--primary-hover)}
    button.secondary{background:var(--gray);color:var(--text);border:1px solid var(--border)}
    button.danger{background:var(--danger);color:#fff}
    button.danger:hover{background:#B91C1C}
    details summary{cursor:pointer;color:var(--primary);font-weight:600}
    .gallery{display:grid;gap:20px;margin-top:24px;grid-template-columns:1fr}
    @media(min-width:768px){
      .gallery{grid-template-columns:repeat(2,1fr)}
    }
    .slide{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow);overflow:hidden;position:relative}
    .slide img{width:100%;display:block}
    .slide-controls{display:flex;gap:8px;padding:14px;border-top:1px solid var(--border);background:var(--gray);flex-wrap:wrap}
    .slide-controls button{font-size:14px;padding:10px 14px;flex:1;min-width:120px;font-weight:600;border-radius:10px;transition:all .2s}
    .btn-settings{background:#8B5CF6;color:#fff}
    .btn-settings:hover{background:#7C3AED}
    .btn-text{background:#0D9668;color:#fff}
    .btn-text:hover{background:#0A7A52}
    .btn-download{background:#2563EB;color:#fff}
    .btn-download:hover{background:#1D4ED8}
    .btn-delete{background:var(--danger);color:#fff;position:absolute;top:10px;right:10px;width:32px;height:32px;padding:0;border-radius:50%;font-size:18px;z-index:10;display:flex;align-items:center;justify-content:center}
    .btn-delete:hover{background:#B91C1C}
    .add-slide-container{text-align:center;margin:24px 0}
    .btn-add-slide{background:var(--primary);color:#fff;padding:14px 24px;font-size:16px;border-radius:var(--radius-md)}
    .btn-add-slide:hover{background:var(--primary-hover)}
    footer{margin-top:24px;text-align:center;color:var(--muted);font-size:14px}
    
    .format-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .format-btn{background:var(--gray);border:2px solid var(--border);border-radius:var(--radius-md);padding:16px;cursor:pointer;transition:all .2s;text-align:center;font-weight:600}
    .format-btn:hover{border-color:var(--primary);background:#EFF6FF}
    .format-btn.active{border-color:var(--primary);background:#DBEAFE;color:var(--primary)}
    
    .slider-group{margin-bottom:16px}
    .slider-label{display:flex;justify-content:space-between;margin-bottom:8px}
    .slider-value{color:var(--primary);font-weight:600}
    .slider-separator{border-bottom:1px solid var(--border);margin:20px 0;}
    input[type=range]{width:100%;height:8px;border-radius:4px;background:var(--gray);outline:none;-webkit-appearance:none}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;border-radius:50%;background:var(--primary);cursor:pointer}
    input[type=range]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--primary);cursor:pointer;border:none}
    
    .modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;overflow:auto;padding:20px}
    .modal.active{display:flex;align-items:center;justify-content:center}
    .modal-content{background:var(--surface);border-radius:var(--radius-lg);max-width:800px;width:100%;max-height:90vh;overflow:auto;padding:24px;position:relative}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-close{background:var(--gray);border:none;border-radius:50%;width:64px;height:64px;cursor:pointer;font-size:40px;line-height:1;display:flex;align-items:center;justify-content:center}
    
    .sticky-buttons{position:sticky;bottom:0;left:0;right:0;background:var(--surface);padding:16px 0;margin-top:24px;border-top:2px solid var(--border);box-shadow:0 -4px 12px rgba(0,0,0,0.1);z-index:100;display:none;gap:12px}
    .sticky-buttons.show{display:flex}
    .sticky-buttons button{flex:1;padding:14px 20px;font-size:16px}
    .bg-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:12px;margin-top:16px}
    .bg-item{aspect-ratio:4/5;border-radius:var(--radius-md);cursor:pointer;border:3px solid transparent;transition:all .2s}
    .bg-item:hover{border-color:var(--primary);transform:scale(1.05)}
    .bg-item.selected{border-color:var(--primary);border-width:4px;box-shadow:0 0 0 2px rgba(37,99,235,.3)}
    
    .final-buttons{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
    
    .align-selector{display:flex;gap:8px;margin-top:12px}
    .align-option{flex:1;padding:10px;border:2px solid var(--border);border-radius:var(--radius-md);cursor:pointer;transition:all .2s;text-align:center;background:var(--gray);display:flex;align-items:center;justify-content:center}
    .align-option:hover{border-color:var(--primary);background:#EFF6FF}
    .align-option.active{border-color:var(--primary);background:#DBEAFE}
    .align-icon{font-size:24px}
    
    .vertical-selector{display:flex;gap:8px;margin-top:12px}
    .vertical-option{flex:1;padding:10px;border:2px solid var(--border);border-radius:var(--radius-md);cursor:pointer;transition:all .2s;text-align:center;background:var(--gray);display:flex;align-items:center;justify-content:center}
    .vertical-option:hover{border-color:var(--primary);background:#EFF6FF}
    .vertical-option.active{border-color:var(--primary);background:#DBEAFE}
    .vertical-icon{font-size:24px}
    
    .slide-number{position:absolute;top:10px;left:10px;background:rgba(0,0,0,0.7);color:#fff;padding:6px 12px;border-radius:20px;font-size:14px;font-weight:600;z-index:10}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>–°–æ–∑–¥–∞—Ç–µ–ª—å –∫–∞—Ä—É—Å–µ–ª–µ–π v2</h1>
      <p class="sub">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ‚Üí –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏ —Ñ–æ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–ª–∞–π–¥–∞ ‚Üí —Å–∫–∞—á–∞–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>
    </header>

    <!-- –ë–ª–æ–∫ 1. –ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <section class="card">
      <h3>–ë–∞–∑–æ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      
      <!-- –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–∞ -->
      <div style="margin-bottom:24px">
        <label>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä</label>
        <div class="format-grid">
          <div class="format-btn active" data-format="4:5">4:5<br>–¥–ª—è –∫–∞—Ä—É—Å–µ–ª–µ–π</div>
          <div class="format-btn" data-format="1:1">1:1<br>–¥–ª—è –∫–∞—Ä—É—Å–µ–ª–µ–π –∏ –ø–æ—Å—Ç–æ–≤</div>
          <div class="format-btn" data-format="9:16">9:16<br>–¥–ª—è –∏—Å—Ç–æ—Ä–∏–π</div>
        </div>
      </div>
      
      <div>
        <label>–ö–∞–∫–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞?</label>
        <select id="textColor">
          <option value="#000000">–ß—ë—Ä–Ω—ã–π</option>
          <option value="#ffffff" selected>–ë–µ–ª—ã–π</option>
        </select>
      </div>
      <div style="margin-top:16px;">
        <label>–ö–∞–∫–æ–π –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ü–≤–µ—Ç –ø–æ–¥–ª–æ–∂–∫–∏?</label>
        <select id="backdropColor">
          <option value="0,0,0" selected>–ß—ë—Ä–Ω–∞—è</option>
          <option value="255,255,255">–ë–µ–ª–∞—è</option>
        </select>
      </div>
      
      <!-- –†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ - –ø–æ–ª–∑—É–Ω–æ–∫ -->
      <div class="slider-group" style="margin-top:16px;">
        <div class="slider-label">
          <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</label>
          <span class="slider-value" id="fontSizeValue">45px</span>
        </div>
        <input id="fontSize" type="range" min="40" max="160" value="45">
      </div>
      
      <!-- –í—ã—Å–æ—Ç–∞ –ø–æ–¥–ª–æ–∂–∫–∏ - –ø–æ–ª–∑—É–Ω–æ–∫ -->
      <div class="slider-group" style="margin-top:16px;">
        <div class="slider-label">
          <label>–í—ã—Å–æ—Ç–∞ –ø–æ–¥–ª–æ–∂–∫–∏</label>
          <span class="slider-value" id="fadePctValue">60%</span>
        </div>
        <input id="fadePct" type="range" min="10" max="100" value="60">
      </div>
      
      <!-- –ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ–¥–ª–æ–∂–∫–∏ - –ø–æ–ª–∑—É–Ω–æ–∫ -->
      <div class="slider-group" style="margin-top:16px;">
        <div class="slider-label">
          <label>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–æ–¥–ª–æ–∂–∫–∏</label>
          <span class="slider-value" id="backdropOpacityValue">1.00</span>
        </div>
        <input id="backdropOpacity" type="range" min="0" max="1" step="0.05" value="1">
      </div>
    </section>

    <!-- –ë–ª–æ–∫ 2. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
    <section class="card">
      <details>
        <summary>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ <span style="color:var(--muted)">(–Ω–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å)</span></summary>
        <div style="margin-top:16px;display:grid;gap:16px;">
          <div>
            <label>–®—Ä–∏—Ñ—Ç</label>
            <select id="fontFamily">
              <option value="'Montserrat', sans-serif" selected>Montserrat</option>
              <option value="'Playfair Display', serif">Playfair Display</option>
              <option value="'Lora', serif">Lora</option>
              <option value="'Open Sans', sans-serif">Open Sans</option>
              <option value="'Raleway', sans-serif">Raleway</option>
              <option value="-apple-system, BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Helvetica,Arial,sans-serif">–°–∏—Å—Ç–µ–º–Ω—ã–π</option>
            </select>
          </div>
          
          <div class="slider-separator"></div>
          
          <div class="slider-group">
            <div class="slider-label">
              <label>–¢–µ–Ω—å —Ç–µ–∫—Å—Ç–∞</label>
              <span class="slider-value" id="shadowValue">0.50</span>
            </div>
            <input id="shadow" type="range" min="0" max="1" step="0.05" value="0.5">
          </div>
          
          <div class="slider-separator"></div>
          
          <div class="slider-group">
            <div class="slider-label">
              <label>–ú–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</label>
              <span class="slider-value" id="lineHeightValue">1.25</span>
            </div>
            <input id="lineHeight" type="range" min="1.1" max="2" step="0.05" value="1.25">
          </div>
          
          <div class="slider-separator"></div>
          
          <div class="slider-group">
            <div class="slider-label">
              <label>–û—Ç—Å—Ç—É–ø —Ç–µ–∫—Å—Ç–∞</label>
              <span class="slider-value" id="paddingValue">64px</span>
            </div>
            <input id="padding" type="range" min="24" max="120" value="64">
          </div>
          
          <div class="slider-separator"></div>
          
          <div class="slider-group">
            <div class="slider-label">
              <label>–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤</label>
              <span class="slider-value" id="cornerRadiusValue">0px</span>
            </div>
            <input id="cornerRadius" type="range" min="0" max="80" value="0">
          </div>
        </div>
      </details>
    </section>

    <section id="results" class="gallery"></section>
    
    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–∞–π–¥ -->
    <div class="add-slide-container">
      <button id="addSlideBtn" class="btn-add-slide">+ –î–æ–±–∞–≤–∏—Ç—å —Å–ª–∞–π–¥</button>
    </div>
    
    <!-- –§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
    <section class="card final-buttons">
      <button id="clearAll" class="secondary">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
      <button id="downloadAll" class="primary">–°–∫–∞—á–∞—Ç—å –≤—Å—ë</button>
    </section>

    <footer style="height:1cm;"></footer>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–ª–∞–π–¥–∞ -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–ª–∞–π–¥–∞</h3>
        <button class="modal-close" onclick="document.getElementById('settingsModal').classList.remove('active')">√ó</button>
      </div>
      
      <div id="settingsMainMenu" style="display:grid;gap:16px;">
        <button id="chooseBgBtn" class="primary" style="width:100%;padding:14px">üé® –í—ã–±—Ä–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ñ–æ–Ω</button>
        <button id="uploadPhotoBtn" class="primary" style="width:100%;padding:14px">üì∑ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <button id="addPatternBtn" class="primary" style="width:100%;padding:14px">‚ú® –î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω</button>
      </div>
      
      <div id="bgSelectorMenu" style="display:none;">
        <button id="backFromBg" class="secondary" style="margin-bottom:16px">‚Üê –ù–∞–∑–∞–¥</button>
        <div>
          <h4>–û–¥–Ω–æ—Ç–æ–Ω–Ω—ã–µ —Ñ–æ–Ω—ã</h4>
          <div class="bg-grid" id="solidBgs"></div>
          
          <h4 style="margin-top:24px">–Ø—Ä–∫–∏–µ –∞–∫—Ü–µ–Ω—Ç–Ω—ã–µ —Ñ–æ–Ω—ã</h4>
          <div class="bg-grid" id="accentBgs"></div>
          
          <div style="padding:16px;margin-top:16px;background:var(--gray);border-radius:var(--radius-md);text-align:center;color:var(--muted)">
            üí° –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ–Ω
          </div>
        </div>
        
        <div id="bgApplyButtons" class="sticky-buttons">
          <button id="applyBgAll" class="secondary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º —Å–ª–∞–π–¥–∞–º</button>
          <button id="applyBgOne" class="primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —ç—Ç–æ–º—É —Å–ª–∞–π–¥—É</button>
        </div>
      </div>
      
      <div id="patternMenu" style="display:none;">
        <button id="backFromPattern" class="secondary" style="margin-bottom:16px">‚Üê –ù–∞–∑–∞–¥</button>
        <div>
          <label>–¢–∏–ø –ø–∞—Ç—Ç–µ—Ä–Ω–∞</label>
          <select id="patternType">
            <option value="none">–ë–µ–∑ –ø–∞—Ç—Ç–µ—Ä–Ω–∞</option>
            <option value="dots">–¢–æ—á–∫–∏</option>
            <option value="diamonds">–†–æ–º–±—ã</option>
            <option value="grid">–°–µ—Ç–∫–∞</option>
            <option value="vlines">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã</option>
            <option value="hlines">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª–æ—Å—ã</option>
            <option value="waves">–í–æ–ª–Ω—ã</option>
            <option value="crumpled">–ú—è—Ç–∞—è –±—É–º–∞–≥–∞</option>
          </select>
        </div>
        <div class="slider-group" style="margin-top:16px;">
          <div class="slider-label">
            <label>–†–∞–∑–º–µ—Ä –ø–∞—Ç—Ç–µ—Ä–Ω–∞</label>
            <span class="slider-value" id="patternSizeValue">30</span>
          </div>
          <input id="patternSize" type="range" min="10" max="100" value="30">
        </div>
        <div class="slider-group">
          <div class="slider-label">
            <label>–Ø—Ä–∫–æ—Å—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–∞</label>
            <span class="slider-value" id="patternOpacityValue">0.20</span>
          </div>
          <input id="patternOpacity" type="range" min="0" max="1" step="0.05" value="0.2">
        </div>
        
        <div style="padding:16px;margin-top:16px;background:var(--gray);border-radius:var(--radius-md);text-align:center;color:var(--muted)">
          üí° –ò–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ç—Ç–µ—Ä–Ω–∞
        </div>
        
        <div id="patternApplyButtons" class="sticky-buttons">
          <button id="applyPatternAll" class="secondary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ –≤—Å–µ–º —Å–ª–∞–π–¥–∞–º</button>
          <button id="applyPatternOne" class="primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫ —ç—Ç–æ–º—É —Å–ª–∞–π–¥—É</button>
        </div>
      </div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–µ–∫—Å—Ç–∞ -->
  <div id="textModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</h3>
        <button class="modal-close" onclick="document.getElementById('textModal').classList.remove('active')">√ó</button>
      </div>
      
      <div style="display:grid;gap:16px;">
        <div>
          <label>–¢–µ–∫—Å—Ç —Å–ª–∞–π–¥–∞</label>
          <textarea id="slideText" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –¥–ª—è —ç—Ç–æ–≥–æ —Å–ª–∞–π–¥–∞..."></textarea>
        </div>
        
        <div>
          <label>–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</label>
          <div class="align-selector">
            <div class="align-option active" data-align="left">
              <div class="align-icon">‚¨ÖÔ∏è</div>
            </div>
            <div class="align-option" data-align="center">
              <div class="align-icon">‚ÜîÔ∏è</div>
            </div>
            <div class="align-option" data-align="right">
              <div class="align-icon">‚û°Ô∏è</div>
            </div>
          </div>
        </div>
        
        <div>
          <label>–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</label>
          <div class="vertical-selector">
            <div class="vertical-option active" data-vertical="bottom">
              <div class="vertical-icon">‚¨áÔ∏è</div>
            </div>
            <div class="vertical-option" data-vertical="center">
              <div class="vertical-icon">‚ÜïÔ∏è</div>
            </div>
          </div>
        </div>
        
        <div class="slider-group">
          <div class="slider-label">
            <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–ª–∞–π–¥–∞</label>
            <span class="slider-value" id="slideFontSizeValue">45px</span>
          </div>
          <input id="slideFontSize" type="range" min="40" max="160" value="45">
        </div>
        
        <div style="display:flex;gap:12px;margin-top:24px;">
          <button id="applyText" class="primary" style="flex:1">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    if(window.igApp&&window.igApp.destroy){window.igApp.destroy();if(window.igApp.filePicker)window.igApp.filePicker.remove()}
    
    let CANVAS_W=1080,CANVAS_H=1350;
    let currentFormat='4:5';
    
    const results=document.getElementById('results');
    const addSlideBtn=document.getElementById('addSlideBtn');
    const clearAllBtn=document.getElementById('clearAll');
    const downloadAllBtn=document.getElementById('downloadAll');

    const fontFamily=document.getElementById('fontFamily');
    const fontSizeInput=document.getElementById('fontSize');
    const lineHeightInput=document.getElementById('lineHeight');
    const paddingInput=document.getElementById('padding');
    const fadePctInput=document.getElementById('fadePct');
    const backdropOpacityInput=document.getElementById('backdropOpacity');
    const backdropColorInput=document.getElementById('backdropColor');
    const cornerRadiusInput=document.getElementById('cornerRadius');
    const textColorInput=document.getElementById('textColor');
    const shadowInput=document.getElementById('shadow');
    
    const fontSizeValue=document.getElementById('fontSizeValue');
    const fadePctValue=document.getElementById('fadePctValue');
    const backdropOpacityValue=document.getElementById('backdropOpacityValue');
    const shadowValue=document.getElementById('shadowValue');
    const lineHeightValue=document.getElementById('lineHeightValue');
    const paddingValue=document.getElementById('paddingValue');
    const cornerRadiusValue=document.getElementById('cornerRadiusValue');
    
    const patternType=document.getElementById('patternType');
    const patternSize=document.getElementById('patternSize');
    const patternOpacity=document.getElementById('patternOpacity');
    const patternSizeValue=document.getElementById('patternSizeValue');
    const patternOpacityValue=document.getElementById('patternOpacityValue');
    const applyPatternOneBtn=document.getElementById('applyPatternOne');
    const applyPatternAllBtn=document.getElementById('applyPatternAll');
    const uploadPhotoBtn=document.getElementById('uploadPhotoBtn');
    const chooseBgBtn=document.getElementById('chooseBgBtn');
    const addPatternBtn=document.getElementById('addPatternBtn');
    const backFromBg=document.getElementById('backFromBg');
    const backFromPattern=document.getElementById('backFromPattern');
    const applyBgOneBtn=document.getElementById('applyBgOne');
    const applyBgAllBtn=document.getElementById('applyBgAll');
    const bgApplyButtons=document.getElementById('bgApplyButtons');
    const patternApplyButtons=document.getElementById('patternApplyButtons');

    const slideText=document.getElementById('slideText');
    const slideFontSize=document.getElementById('slideFontSize');
    const slideFontSizeValue=document.getElementById('slideFontSizeValue');
    const applyTextBtn=document.getElementById('applyText');
    
    const settingsMainMenu=document.getElementById('settingsMainMenu');
    const bgSelectorMenu=document.getElementById('bgSelectorMenu');
    const patternMenu=document.getElementById('patternMenu');

    const destroyFns=[];
    function on(el,ev,fn){el.addEventListener(ev,fn);destroyFns.push(()=>el.removeEventListener(ev,fn))}
    
    let slides=[];
    let pendingIndex=null;
    let selectedBgColor=null;
    let patternChanged=false;
    
    const filePicker=document.createElement('input');
    filePicker.type='file';filePicker.accept='image/*';filePicker.style.display='none';
    document.body.appendChild(filePicker);

    const solidColors=[
      '#8B7355','#A0826D','#6B5B4F','#9B8B7E','#7D6E5C',
      '#B8A99A','#C8B8A8','#D4C5B7','#E5DDD5','#F5F0EB',
      '#4A5D5E','#5C7A7C','#7FA1A3','#9BB8BA','#C1D5D7',
      '#6B7C8C','#8497A7','#9DAFC0','#B6C7D6','#CFE0ED'
    ];
    
    const accentColors=[
      '#8B1874','#D946EF','#FFD700','#FF6B9D','#10B981',
      '#F59E0B','#EC4899','#3B82F6','#8B5CF6','#14B8A6'
    ];

    fontSizeInput.oninput=()=>{fontSizeValue.textContent=fontSizeInput.value+'px';triggerRender()};
    fadePctInput.oninput=()=>{fadePctValue.textContent=fadePctInput.value+'%';triggerRender()};
    backdropOpacityInput.oninput=()=>{backdropOpacityValue.textContent=parseFloat(backdropOpacityInput.value).toFixed(2);triggerRender()};
    shadowInput.oninput=()=>{shadowValue.textContent=parseFloat(shadowInput.value).toFixed(2);triggerRender()};
    lineHeightInput.oninput=()=>{lineHeightValue.textContent=parseFloat(lineHeightInput.value).toFixed(2);triggerRender()};
    paddingInput.oninput=()=>{paddingValue.textContent=paddingInput.value+'px';triggerRender()};
    cornerRadiusInput.oninput=()=>{cornerRadiusValue.textContent=cornerRadiusInput.value+'px';triggerRender()};
    
    patternSize.oninput=()=>{
      patternSizeValue.textContent=patternSize.value;
      patternChanged=true;
      patternApplyButtons.classList.add('show');
    };
    patternOpacity.oninput=()=>{
      patternOpacityValue.textContent=parseFloat(patternOpacity.value).toFixed(2);
      patternChanged=true;
      patternApplyButtons.classList.add('show');
    };
    patternType.onchange=()=>{
      patternChanged=true;
      patternApplyButtons.classList.add('show');
    };

    slideFontSize.oninput=()=>{slideFontSizeValue.textContent=slideFontSize.value+'px'};

    textColorInput.onchange=()=>{
      if(textColorInput.value==='#000000'){
        shadowInput.value='0';
        shadowValue.textContent='0.00';
      }else if(textColorInput.value==='#ffffff'){
        shadowInput.value='0.5';
        shadowValue.textContent='0.50';
      }
      triggerRender();
    };

    on(filePicker,'change',async e=>{
      const f=e.target.files&&e.target.files[0];
      if(!f)return;
      if(pendingIndex==null)return;
      const url=await fileToDataURL(f);
      const img=await urlToImage(url);
      slides[pendingIndex].image=img;
      slides[pendingIndex].bgColor=null;
      await renderOne(pendingIndex);
      pendingIndex=null;
      filePicker.value='';
    });

    document.querySelectorAll('.format-btn').forEach(btn=>{
      btn.onclick=()=>{
        document.querySelectorAll('.format-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const format=btn.dataset.format;
        currentFormat=format;
        if(format==='4:5'){CANVAS_W=1080;CANVAS_H=1350}
        else if(format==='1:1'){CANVAS_W=1080;CANVAS_H=1080}
        else if(format==='9:16'){CANVAS_W=1080;CANVAS_H=1920}
        triggerRender();
      };
    });

    const solidBgs=document.getElementById('solidBgs');
    const accentBgs=document.getElementById('accentBgs');
    
    solidColors.forEach(color=>{
      const div=document.createElement('div');
      div.className='bg-item';
      div.style.background=color;
      div.onclick=()=>{
        document.querySelectorAll('.bg-item').forEach(b=>b.classList.remove('selected'));
        div.classList.add('selected');
        selectedBgColor=color;
        bgApplyButtons.classList.add('show');
      };
      solidBgs.appendChild(div);
    });
    
    accentColors.forEach(color=>{
      const div=document.createElement('div');
      div.className='bg-item';
      div.style.background=color;
      div.onclick=()=>{
        document.querySelectorAll('.bg-item').forEach(b=>b.classList.remove('selected'));
        div.classList.add('selected');
        selectedBgColor=color;
        bgApplyButtons.classList.add('show');
      };
      accentBgs.appendChild(div);
    });

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫
    chooseBgBtn.onclick=()=>{
      settingsMainMenu.style.display='none';
      bgSelectorMenu.style.display='block';
      patternMenu.style.display='none';
      selectedBgColor=null;
      bgApplyButtons.classList.remove('show');
      document.querySelectorAll('.bg-item').forEach(b=>b.classList.remove('selected'));
    };
    
    addPatternBtn.onclick=()=>{
      settingsMainMenu.style.display='none';
      bgSelectorMenu.style.display='none';
      patternMenu.style.display='block';
      patternChanged=false;
      patternApplyButtons.classList.remove('show');
    };
    
    backFromBg.onclick=()=>{
      settingsMainMenu.style.display='grid';
      bgSelectorMenu.style.display='none';
      patternMenu.style.display='none';
    };
    
    backFromPattern.onclick=()=>{
      settingsMainMenu.style.display='grid';
      bgSelectorMenu.style.display='none';
      patternMenu.style.display='none';
    };
    
    applyBgOneBtn.onclick=()=>{
      if(pendingIndex!=null && selectedBgColor){
        slides[pendingIndex].bgColor=selectedBgColor;
        slides[pendingIndex].image=null;
        renderOne(pendingIndex);
        document.getElementById('settingsModal').classList.remove('active');
        settingsMainMenu.style.display='grid';
        bgSelectorMenu.style.display='none';
        pendingIndex=null;
      }
    };
    
    applyBgAllBtn.onclick=()=>{
      if(selectedBgColor){
        slides.forEach(s=>{
          s.bgColor=selectedBgColor;
          s.image=null;
        });
        renderAll();
        document.getElementById('settingsModal').classList.remove('active');
        settingsMainMenu.style.display='grid';
        bgSelectorMenu.style.display='none';
        pendingIndex=null;
      }
    };

    uploadPhotoBtn.onclick=()=>{
      filePicker.click();
    };

    applyPatternOneBtn.onclick=()=>{
      if(pendingIndex!=null){
        slides[pendingIndex].pattern={
          type:patternType.value,
          size:parseInt(patternSize.value),
          opacity:parseFloat(patternOpacity.value)
        };
        renderOne(pendingIndex);
        document.getElementById('settingsModal').classList.remove('active');
        settingsMainMenu.style.display='grid';
        patternMenu.style.display='none';
        pendingIndex=null;
      }
    };
    
    applyPatternAllBtn.onclick=()=>{
      const patternData={
        type:patternType.value,
        size:parseInt(patternSize.value),
        opacity:parseFloat(patternOpacity.value)
      };
      slides.forEach(s=>{
        s.pattern=patternData;
      });
      renderAll();
      document.getElementById('settingsModal').classList.remove('active');
      settingsMainMenu.style.display='grid';
      patternMenu.style.display='none';
      pendingIndex=null;
    };

    applyTextBtn.onclick=()=>{
      if(pendingIndex!=null){
        slides[pendingIndex].text=slideText.value;
        slides[pendingIndex].fontSize=parseInt(slideFontSize.value);
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
        const selectedAlign=document.querySelector('.align-option.active');
        if(selectedAlign){
          slides[pendingIndex].align=selectedAlign.dataset.align;
        }
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
        const selectedVertical=document.querySelector('.vertical-option.active');
        if(selectedVertical){
          slides[pendingIndex].verticalAlign=selectedVertical.dataset.vertical;
        }
        
        renderOne(pendingIndex);
        document.getElementById('textModal').classList.remove('active');
        pendingIndex=null;
      }
    };
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
    document.querySelectorAll('.align-option').forEach(opt=>{
      opt.onclick=()=>{
        document.querySelectorAll('.align-option').forEach(o=>o.classList.remove('active'));
        opt.classList.add('active');
      };
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
    document.querySelectorAll('.vertical-option').forEach(opt=>{
      opt.onclick=()=>{
        document.querySelectorAll('.vertical-option').forEach(o=>o.classList.remove('active'));
        opt.classList.add('active');
      };
    });
    
    async function ensureFonts(){
      if(document.fonts&&document.fonts.ready){
        try{await document.fonts.ready}catch{}
      }
    }
    
    let renderTimeout;
    function triggerRender(){
      clearTimeout(renderTimeout);
      renderTimeout=setTimeout(async()=>{
        await renderAll();
      },300);
    }
    
    async function renderAll(){
      results.innerHTML='';
      await ensureFonts();
      for(let i=0;i<slides.length;i++){
        await renderOne(i);
      }
    }
    
    async function renderOne(i){
      const s=slides[i];
      const canvas=document.createElement('canvas');
      canvas.width=CANVAS_W;
      canvas.height=CANVAS_H;
      const ctx=canvas.getContext('2d');
      
      const radius=clamp(parseInt(cornerRadiusInput.value||0),0,80);
      if(radius>0){
        roundedRect(ctx,0,0,CANVAS_W,CANVAS_H,radius);
        ctx.clip();
      }
      
      if(s.image){
        drawCover(ctx,s.image,CANVAS_W,CANVAS_H);
      }else if(s.bgColor){
        ctx.fillStyle=s.bgColor;
        ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
      }else{
        ctx.fillStyle='#F1F5F9';
        ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
      }
      
      if(s.pattern&&s.pattern.type!=='none'){
        drawPattern(ctx,s.pattern.type,s.pattern.size,s.pattern.opacity,CANVAS_W,CANVAS_H);
      }
      
      const fadePct=clamp(parseInt(fadePctInput.value||60),10,100)/100;
      const back=clamp(parseFloat(backdropOpacityInput.value||1),0,1);
      const [r,g,b]=backdropColorInput.value.split(',').map(Number);
      const grad=ctx.createLinearGradient(0,CANVAS_H,0,CANVAS_H*(1-fadePct));
      grad.addColorStop(0,`rgba(${r},${g},${b},${back})`);
      grad.addColorStop(1,`rgba(${r},${g},${b},0)`);
      ctx.fillStyle=grad;
      ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
      
      if(s.text){
        const pad=clamp(parseInt(paddingInput.value||64),16,160);
        const fontSize=s.fontSize!=null?clamp(s.fontSize,40,160):clamp(parseInt(fontSizeInput.value||45),40,160);
        const lh=clamp(parseFloat(lineHeightInput.value||1.25),1.1,2);
        const color=textColorInput.value||'#fff';
        const shadow=clamp(parseFloat(shadowInput.value||0.5),0,1);
        const align=s.align||'left';
        
        ctx.fillStyle=color;
        ctx.textBaseline='alphabetic';
        
        if(shadow>0){
          ctx.shadowColor=`rgba(0,0,0,${shadow})`;
          ctx.shadowBlur=8;
          ctx.shadowOffsetY=2;
        }else{
          ctx.shadowColor='transparent';
          ctx.shadowBlur=0;
          ctx.shadowOffsetY=0;
        }
        
        const left=pad,right=CANVAS_W-pad,width=right-left,bottom=CANVAS_H-pad,top=CANVAS_H*(1-fadePct)+pad*0.25;
        
        ctx.font=`${fontSize}px ${fontFamily?fontFamily.value:"sans-serif"}`;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
        const lines=wrapWithNewlines(ctx,s.text,width);
        
        const lineH=fontSize*lh;
        const total=lines.length*lineH;
        
        // –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
        const verticalAlign=s.verticalAlign||'bottom';
        let y;
        
        if(verticalAlign==='center'){
          // –ü–æ —Ü–µ–Ω—Ç—Ä—É –≤—Å–µ–≥–æ —Å–ª–∞–π–¥–∞ (CANVAS_H / 2)
          const centerY=CANVAS_H/2;
          y=centerY-(total/2)+lineH;
        }else{
          // –í–Ω–∏–∑—É (–∫–∞–∫ –±—ã–ª–æ —Ä–∞–Ω—å—à–µ)
          y=Math.min(bottom,Math.max(top+lineH,bottom-total+lineH*0.2));
        }
        
        for(const line of lines){
          let x;
          if(align==='center'){x=CANVAS_W/2;ctx.textAlign='center'}
          else if(align==='right'){x=right;ctx.textAlign='right'}
          else{x=left;ctx.textAlign='left'}
          
          ctx.fillText(line,x,y);
          y+=lineH;
        }
        
        ctx.shadowColor='transparent';
        ctx.shadowBlur=0;
        ctx.shadowOffsetY=0;
      }
      
      const dataURL=canvas.toDataURL('image/png');
      let host=results.querySelector(`[data-slide='${i}']`);
      
      if(!host){
        host=document.createElement('div');
        host.className='slide';
        host.dataset.slide=String(i);
        
        const num=document.createElement('div');
        num.className='slide-number';
        num.textContent=`${i+1}`;
        host.appendChild(num);
        
        const deleteBtn=document.createElement('button');
        deleteBtn.className='btn-delete';
        deleteBtn.textContent='√ó';
        deleteBtn.onclick=()=>{
          slides.splice(i,1);
          renderAll();
        };
        host.appendChild(deleteBtn);
        
        const img=document.createElement('img');
        img.className='slide-img';
        host.appendChild(img);
        
        const ctrls=document.createElement('div');
        ctrls.className='slide-controls';
        
        const settingsBtn=document.createElement('button');
        settingsBtn.className='btn-settings';
        settingsBtn.textContent='‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏';
        settingsBtn.onclick=()=>{
          pendingIndex=i;
          settingsMainMenu.style.display='grid';
          bgSelectorMenu.style.display='none';
          patternMenu.style.display='none';
          document.getElementById('settingsModal').classList.add('active');
        };
        ctrls.appendChild(settingsBtn);
        
        const textBtn=document.createElement('button');
        textBtn.className='btn-text';
        textBtn.textContent='üìù –¢–µ–∫—Å—Ç';
        textBtn.onclick=()=>{
          pendingIndex=i;
          slideText.value=slides[i].text||'';
          if(slides[i].fontSize!=null){
            slideFontSize.value=slides[i].fontSize;
            slideFontSizeValue.textContent=slides[i].fontSize+'px';
          }else{
            slideFontSize.value=fontSizeInput.value;
            slideFontSizeValue.textContent=fontSizeInput.value+'px';
          }
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
          const currentAlign=slides[i].align||'left';
          document.querySelectorAll('.align-option').forEach(opt=>{
            if(opt.dataset.align===currentAlign){
              opt.classList.add('active');
            }else{
              opt.classList.remove('active');
            }
          });
          
          // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
          const currentVertical=slides[i].verticalAlign||'bottom';
          document.querySelectorAll('.vertical-option').forEach(opt=>{
            if(opt.dataset.vertical===currentVertical){
              opt.classList.add('active');
            }else{
              opt.classList.remove('active');
            }
          });
          
          document.getElementById('textModal').classList.add('active');
        };
        ctrls.appendChild(textBtn);
        
        const downloadBtn=document.createElement('button');
        downloadBtn.className='btn-download';
        downloadBtn.textContent='‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å';
        downloadBtn.onclick=()=>{
          const a=document.createElement('a');
          a.href=host.querySelector('.slide-img').src;
          a.download=`slide_${String(i+1).padStart(2,'0')}.png`;
          a.click();
        };
        ctrls.appendChild(downloadBtn);
        
        host.appendChild(ctrls);
        results.appendChild(host);
      }
      
      host.querySelector('.slide-img').src=dataURL;
      host.querySelector('.slide-number').textContent=`${i+1}`;
    }
    
    function drawPattern(ctx,type,size,opacity,w,h){
      const temp=document.createElement('canvas');
      temp.width=w;
      temp.height=h;
      const tctx=temp.getContext('2d');
      
      tctx.strokeStyle=`rgba(255,255,255,${opacity})`;
      tctx.fillStyle=`rgba(255,255,255,${opacity})`;
      tctx.lineWidth=2;
      
      if(type==='dots'){
        for(let y=0;y<h;y+=size){
          for(let x=0;x<w;x+=size){
            tctx.beginPath();
            tctx.arc(x,y,size/8,0,Math.PI*2);
            tctx.fill();
          }
        }
      }else if(type==='diamonds'){
        for(let row=0;row<h/size+2;row++){
          for(let col=0;col<w/size+2;col++){
            const x=col*size+(row%2===0?0:size/2);
            const y=row*size*0.866;
            tctx.beginPath();
            tctx.arc(x,y,size/6,0,Math.PI*2);
            tctx.fill();
          }
        }
      }else if(type==='grid'){
        for(let x=0;x<w;x+=size){
          tctx.beginPath();
          tctx.moveTo(x,0);
          tctx.lineTo(x,h);
          tctx.stroke();
        }
        for(let y=0;y<h;y+=size){
          tctx.beginPath();
          tctx.moveTo(0,y);
          tctx.lineTo(w,y);
          tctx.stroke();
        }
      }else if(type==='vlines'){
        for(let x=0;x<w;x+=size){
          tctx.beginPath();
          tctx.moveTo(x,0);
          tctx.lineTo(x,h);
          tctx.stroke();
        }
      }else if(type==='hlines'){
        for(let y=0;y<h;y+=size){
          tctx.beginPath();
          tctx.moveTo(0,y);
          tctx.lineTo(w,y);
          tctx.stroke();
        }
      }else if(type==='waves'){
        tctx.beginPath();
        for(let x=0;x<w;x++){
          const y=h/3+Math.sin(x/size*Math.PI)*size;
          if(x===0)tctx.moveTo(x,y);
          else tctx.lineTo(x,y);
        }
        tctx.stroke();
        tctx.beginPath();
        for(let x=0;x<w;x++){
          const y=h*2/3+Math.sin(x/size*Math.PI)*size;
          if(x===0)tctx.moveTo(x,y);
          else tctx.lineTo(x,y);
        }
        tctx.stroke();
      }else if(type==='crumpled'){
        for(let i=0;i<200;i++){
          const x1=Math.random()*w;
          const y1=Math.random()*h;
          const x2=x1+(Math.random()-0.5)*size;
          const y2=y1+(Math.random()-0.5)*size;
          tctx.beginPath();
          tctx.moveTo(x1,y1);
          tctx.lineTo(x2,y2);
          tctx.stroke();
        }
      }
      
      ctx.drawImage(temp,0,0);
    }
    
    function drawCover(ctx,img,w,h){
      const r=img.width/img.height;
      const R=w/h;
      let dw,dh,dx,dy;
      if(r>R){dh=h;dw=h*r;dx=(w-dw)/2;dy=0}
      else{dw=w;dh=w/r;dx=0;dy=(h-dh)/2}
      ctx.drawImage(img,dx,dy,dw,dh);
    }
    
    function wrapWithNewlines(ctx,text,maxW){
      const paragraphs=String(text||'').split('\n');
      const out=[];
      
      for(const para of paragraphs){
        // –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è, –¥–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–∞
        if(para.trim()===''){
          out.push('');
          continue;
        }
        
        const words=para.split(/\s+/).filter(Boolean);
        let line='';
        
        for(let i=0;i<words.length;i++){
          const test=line?line+' '+words[i]:words[i];
          if(ctx.measureText(test).width>maxW&&line){
            out.push(line);
            line=words[i];
          }else{
            line=test;
          }
        }
        if(line)out.push(line);
      }
      
      return out;
    }
    
    function roundedRect(ctx,x,y,w,h,r){
      const m=Math.min(w,h)/2;
      r=Math.min(r,m);
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      ctx.closePath();
    }
    
    function clamp(v,min,max){
      return Math.max(min,Math.min(max,Number.isFinite(v)?v:min));
    }
    
    function fileToDataURL(file){
      return new Promise((res,rej)=>{
        const r=new FileReader();
        r.onload=()=>res(r.result);
        r.onerror=rej;
        r.readAsDataURL(file);
      });
    }
    
    function urlToImage(url){
      return new Promise((res,rej)=>{
        const i=new Image();
        i.onload=()=>res(i);
        i.onerror=rej;
        i.src=url;
      });
    }
    
    [fontFamily,backdropColorInput].forEach(el=>{
      on(el,'change',triggerRender);
      on(el,'input',triggerRender);
    });
    
    on(addSlideBtn,'click',()=>{
      slides.push({text:'',image:null,bgColor:null,pattern:null,fontSize:null,align:'left',verticalAlign:'bottom'});
      renderAll();
    });
    
    on(clearAllBtn,'click',()=>{
      slides.forEach(s=>{s.image=null;s.bgColor=null;s.pattern=null;s.text=''});
      renderAll();
    });
    
    on(downloadAllBtn,'click',()=>{
      if(slides.length===0){
        alert('–ù–µ—Ç —Å–ª–∞–π–¥–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è!');
        return;
      }
      slides.forEach((s,i)=>{
        setTimeout(()=>{
          const img=results.querySelector(`[data-slide='${i}'] .slide-img`);
          if(img){
            const a=document.createElement('a');
            a.href=img.src;
            a.download=`slide_${String(i+1).padStart(2,'0')}.png`;
            a.click();
          }
        },i*200);
      });
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è 5 –ø—É—Å—Ç—ã—Ö —Å–ª–∞–π–¥–æ–≤
    for(let i=0;i<5;i++){
      slides.push({text:'',image:null,bgColor:null,pattern:null,fontSize:null,align:'left',verticalAlign:'bottom'});
    }
    
    window.igApp={destroy(){destroyFns.forEach(f=>f());},filePicker};
    renderAll();
  })();
  </script>
</body>
</html> 
