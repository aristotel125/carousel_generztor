<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Создатель каруселей для Instagram</title>

  <style>
    :root{
      --bg:#F8FAFC; --surface:#FFFFFF; --text:#0F172A; --muted:#64748B;
      --border:#E2E8F0; --primary:#2563EB; --primary-hover:#1D4ED8;
      --radius-lg:18px; --radius-md:12px; --shadow:0 6px 20px rgba(15,23,42,.08);
      --gray:#F1F5F9;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:16px/1.6 -apple-system,BlinkMacSystemFont,Roboto,Arial,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:32px 16px}
    header{text-align:center;margin-bottom:32px}
    h1{margin:0 0 12px;font-size:32px;font-weight:700}
    .sub{margin:0;color:var(--muted);font-size:18px}
    .card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow);padding:24px;margin-bottom:24px}
    label{display:block;font-weight:600;margin-bottom:8px;font-size:16px}
    textarea,select,input[type=number]{width:100%;border-radius:var(--radius-md);border:1px solid var(--border);padding:12px 14px;font-size:16px;font-family:inherit;background:#fff;transition:border .2s ease}
    textarea{min-height:160px;resize:vertical}
    textarea:focus,select:focus,input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.25)}
    button{border:none;border-radius:var(--radius-md);font-size:16px;font-weight:600;padding:12px 18px;cursor:pointer;transition:background .2s}
    button.primary{background:var(--primary);color:#fff}
    button.primary:hover{background:var(--primary-hover)}
    button.secondary{background:var(--gray);color:var(--text);border:1px solid var(--border)}
    .counts{display:flex;gap:12px;margin-top:12px;font-size:14px;color:var(--muted)}
    .badge{background:var(--gray);padding:6px 12px;border-radius:999px;font-weight:500}
    details summary{cursor:pointer;color:var(--primary);font-weight:600}
    .gallery{display:grid;gap:20px;margin-top:24px}
    .slide{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);box-shadow:var(--shadow);overflow:hidden}
    .slide img{width:100%;display:block}
    .slide-controls{display:flex;gap:10px;justify-content:flex-end;padding:10px 12px;border-top:1px solid var(--border);background:var(--gray)}
    .slide-controls button{font-size:14px;padding:8px 14px}
    footer{margin-top:24px;text-align:center;color:var(--muted);font-size:14px}
    .hint{font-size:14px;color:var(--muted);margin-top:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Создатель каруселей для Instagram</h1>
      <p class="sub">Вставьте текст → получайте слайды → сохраняйте изображения.</p>
    </header>

    <!-- Блок 1. Вставка текста -->
    <section class="card">
      <label>Вставьте текст для карусели <span style="color:var(--muted)">(каждый абзац = отдельный слайд)</span></label>
      <textarea id="story" placeholder="Абзацы разделяйте пустой строкой (двойной Enter)."></textarea>
      <div class="counts">
        <span class="badge" id="paraCount">Абзацев: 0</span>
        <span class="badge" id="photoCount">С фото: 0/0</span>
      </div>
    </section>

    <!-- Блок 2. Базовые настройки -->
    <section class="card">
      <h3>Базовые настройки</h3>
      <div>
        <label>Какой должен быть цвет текста?</label>
        <select id="textColor">
          <option value="#000000" selected>Чёрный</option>
          <option value="#ffffff">Белый</option>
        </select>
      </div>
      <div style="margin-top:16px;">
        <label>Какой должен быть цвет подложки?</label>
        <select id="backdropColor">
          <option value="0,0,0" selected>Чёрная</option>
          <option value="255,255,255">Белая</option>
        </select>
      </div>
    </section>

    <!-- Подсказка -->
    <section class="card">
      <p class="hint">После изменения любого параметра нажмите кнопку <b>«Обновить слайды»</b>, чтобы увидеть результат.</p>
    </section>

    <!-- Блок 3. Дополнительные настройки -->
    <section class="card">
      <details>
        <summary>Дополнительные настройки <span style="color:var(--muted)">(необязательно)</span></summary>
        <div style="margin-top:16px;display:grid;gap:16px;">
          <div>
            <label>Шрифт</label>
            <select id="fontFamily">
              <option value="'Montserrat', sans-serif" selected>Montserrat</option>
              <option value="'Playfair Display', serif">Playfair Display</option>
              <option value="'Lora', serif">Lora</option>
              <option value="'Open Sans', sans-serif">Open Sans</option>
              <option value="'Raleway', sans-serif">Raleway</option>
              <option value="-apple-system, BlinkMacSystemFont,'Segoe UI',Inter,Roboto,Helvetica,Arial,sans-serif">Системный</option>
            </select>
          </div>
          <div>
            <label>Выравнивание текста</label>
            <select id="textAlign">
              <option value="left" selected>По левому краю</option>
              <option value="center">По центру</option>
              <option value="right">По правому краю</option>
            </select>
          </div>
          <div>
            <label>Размер шрифта (px)</label>
            <input id="fontSize" type="number" min="18" max="64" value="45">
          </div>
          <div>
            <label>Межстрочный интервал</label>
            <input id="lineHeight" type="number" step="0.05" min="1.1" max="2" value="1.25">
          </div>
          <div>
            <label>Отступ текста (px)</label>
            <input id="padding" type="number" min="24" max="120" value="64">
          </div>
          <div>
            <label>Высота подложки (% от холста)</label>
            <input id="fadePct" type="number" min="10" max="100" value="60">
          </div>
          <div>
            <label>Прозрачность подложки (0–1)</label>
            <input id="backdropOpacity" type="number" step="0.05" min="0" max="1" value="1">
          </div>
          <div>
            <label>Скругление углов (px)</label>
            <input id="cornerRadius" type="number" min="0" max="80" value="0">
          </div>
          <div>
            <label>Тень текста (0–1)</label>
            <input id="shadow" type="number" step="0.05" min="0" max="1" value="0.5">
          </div>
          <label><input type="checkbox" id="swipeArrow"> Показывать стрелку «свайп вправо»</label>
        </div>
      </details>
    </section>

    <!-- Кнопки -->
    <section class="card" style="display:flex;gap:12px;justify-content:flex-end;">
      <button id="update" class="primary">Обновить слайды</button>
      <button id="clear" class="secondary">Очистить</button>
    </section>

    <section id="results" class="gallery"></section>

    <footer>
      Размер картинок: 1080×1350 (формат 4:5). Нажмите «Заменить изображение» для выбора фона или кликните по картинке, чтобы сохранить.
    </footer>
  </div>

  <script>
  (function(){
    if(window.igApp&&window.igApp.destroy){window.igApp.destroy();if(window.igApp.filePicker)window.igApp.filePicker.remove()}
    const CANVAS_W=1080,CANVAS_H=1350;
    const storyInput=document.getElementById('story');
    const paraCount=document.getElementById('paraCount');
    const photoCount=document.getElementById('photoCount');
    const results=document.getElementById('results');
    const updateBtn=document.getElementById('update');
    const clearBtn=document.getElementById('clear');

    const fontFamily=document.getElementById('fontFamily');
    const textAlignSel=document.getElementById('textAlign');
    const fontSizeInput=document.getElementById('fontSize');
    const lineHeightInput=document.getElementById('lineHeight');
    const paddingInput=document.getElementById('padding');
    const fadePctInput=document.getElementById('fadePct');
    const backdropOpacityInput=document.getElementById('backdropOpacity');
    const backdropColorInput=document.getElementById('backdropColor');
    const cornerRadiusInput=document.getElementById('cornerRadius');
    const textColorInput=document.getElementById('textColor');
    const shadowInput=document.getElementById('shadow');
    const swipeArrow=document.getElementById('swipeArrow');

    const destroyFns=[];function on(el,ev,fn){el.addEventListener(ev,fn);destroyFns.push(()=>el.removeEventListener(ev,fn))}
    let slides=[];
    let pendingIndex=null;
    const filePicker=document.createElement('input');
    filePicker.type='file';filePicker.accept='image/*';filePicker.style.display='none';
    document.body.appendChild(filePicker);

    on(filePicker,'change',async e=>{const f=e.target.files&&e.target.files[0];if(!f)return;if(pendingIndex==null)return;const url=await fileToDataURL(f);const img=await urlToImage(url);slides[pendingIndex].image=img;await renderOne(pendingIndex);pendingIndex=null;filePicker.value='';updateCounts()});

    function parseParas(){return String(storyInput.value||'').split(/\n\s*\n+/).map(p=>p.replace(/[\t\r]+/g,' ').trim()).filter(Boolean)}
    function buildOrPreserve(){const next=parseParas();if(!slides.length){slides=next.map(t=>({text:t,image:null}))}else{const kept=Math.min(slides.length,next.length);for(let i=0;i<kept;i++){slides[i].text=next[i]}if(next.length>slides.length){for(let i=slides.length;i<next.length;i++){slides.push({text:next[i],image:null})}}else if(next.length<slides.length){slides=slides.slice(0,next.length)}}}
    async function ensureFonts(){if(document.fonts&&document.fonts.ready){try{await document.fonts.ready}catch{}}}
    async function renderAll(){results.innerHTML='';await ensureFonts();for(let i=0;i<slides.length;i++){await renderOne(i)}updateCounts()}
    async function renderOne(i){
      const s=slides[i];
      const canvas=document.createElement('canvas');canvas.width=CANVAS_W;canvas.height=CANVAS_H;const ctx=canvas.getContext('2d');
      const radius=clamp(parseInt(cornerRadiusInput.value||0),0,80);if(radius>0){roundedRect(ctx,0,0,CANVAS_W,CANVAS_H,radius);ctx.clip()}
      if(s.image){drawCover(ctx,s.image,CANVAS_W,CANVAS_H)}else{ctx.fillStyle='#F1F5F9';ctx.fillRect(0,0,CANVAS_W,CANVAS_H)}
      const fadePct=clamp(parseInt(fadePctInput.value||60),10,100)/100;
      const back=clamp(parseFloat(backdropOpacityInput.value||1),0,1);
      const [r,g,b]=backdropColorInput.value.split(',').map(Number);
      const grad=ctx.createLinearGradient(0,CANVAS_H,0,CANVAS_H*(1-fadePct));
      grad.addColorStop(0,`rgba(${r},${g},${b},${back})`);
      grad.addColorStop(1,`rgba(${r},${g},${b},0)`);
      ctx.fillStyle=grad;ctx.fillRect(0,0,CANVAS_W,CANVAS_H);
      const pad=clamp(parseInt(paddingInput.value||64),16,160);
      const fontSize=clamp(parseInt(fontSizeInput.value||45),18,72);
      const lh=clamp(parseFloat(lineHeightInput.value||1.25),1.1,2);
      const color=textColorInput.value||'#000';
      const shadow=clamp(parseFloat(shadowInput.value||0.5),0,1);
      const align=textAlignSel?textAlignSel.value:'left';
      ctx.fillStyle=color;ctx.font=`${fontSize}px ${fontFamily?fontFamily.value:"sans-serif"}`;ctx.textBaseline='alphabetic';
      if(shadow>0){ctx.shadowColor=`rgba(0,0,0,${shadow})`;ctx.shadowBlur=8;ctx.shadowOffsetY=2}else{ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.shadowOffsetY=0}
      const left=pad,right=CANVAS_W-pad,width=right-left,bottom=CANVAS_H-pad,top=CANVAS_H*(1-fadePct)+pad*0.25;
      const lines=wrap(ctx,s.text,width);const lineH=fontSize*lh;const total=lines.length*lineH;
      let y=Math.min(bottom,Math.max(top+lineH,bottom-total+lineH*0.2));
      for(const line of lines){let x;if(align==='center'){x=CANVAS_W/2;ctx.textAlign='center'}else if(align==='right'){x=right;ctx.textAlign='right'}else{x=left;ctx.textAlign='left'}ctx.fillText(line,x,y);y+=lineH}
      ctx.shadowColor='transparent';ctx.shadowBlur=0;ctx.shadowOffsetY=0;
      if(swipeArrow.checked&&i<slides.length-1){const size=Math.min(80,Math.max(56,CANVAS_W*0.06));const cx=CANVAS_W-pad-size/2;const cy=CANVAS_H-pad/2;drawArrow(ctx,cx,cy,size)}
      const dataURL=canvas.toDataURL('image/png');let host=results.querySelector(`[data-slide='${i}']`);if(!host){host=document.createElement('div');host.className='slide';host.dataset.slide=String(i);const img=document.createElement('img');img.className='slide-img';host.appendChild(img);const ctrls=document.createElement('div');ctrls.className='slide-controls';const rep=document.createElement('button');rep.textContent='Заменить изображение';rep.addEventListener('click',()=>{pendingIndex=i;filePicker.click()});ctrls.appendChild(rep);host.addEventListener('click',ev=>{if(ev.target.tagName.toLowerCase()==='button')return;const a=document.createElement('a');a.href=host.querySelector('.slide-img').src;a.download=`slide_${String(i+1).padStart(2,'0')}.png`;a.click()});host.appendChild(ctrls);results.appendChild(host)}host.querySelector('.slide-img').src=dataURL}
    function drawCover(ctx,img,w,h){const r=img.width/img.height;const R=w/h;let dw,dh,dx,dy;if(r>R){dh=h;dw=h*r;dx=(w-dw)/2;dy=0}else{dw=w;dh=w/r;dx=0;dy=(h-dh)/2}ctx.drawImage(img,dx,dy,dw,dh)}
    function wrap(ctx,text,maxW){const words=String(text||'').split(/\s+/);const out=[];let line='';for(let i=0;i<words.length;i++){const test=line?line+' '+words[i]:words[i];if(ctx.measureText(test).width>maxW&&line){out.push(line);line=words[i]}else{line=test}}if(line)out.push(line);return out}
    function roundedRect(ctx,x,y,w,h,r){const m=Math.min(w,h)/2;r=Math.min(r,m);ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath()}
    function clamp(v,min,max){return Math.max(min,Math.min(max,Number.isFinite(v)?v:min))}
    function fileToDataURL(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(file)})}
    function urlToImage(url){return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=url})}
    function drawArrow(ctx,cx,cy,size){const r=size/2;ctx.save();ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle='rgba(0,0,0,0.35)';ctx.fill();ctx.lineWidth=Math.max(4,size*0.12);ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle='rgba(255,255,255,0.95)';const ax1=cx-size*0.18,ay1=cy-size*0.2,ax2=cx+size*0.18,ay2=cy,ax3=cx-size*0.18,ay3=cy+size*0.2;ctx.beginPath();ctx.moveTo(ax1,ay1);ctx.lineTo(ax2,ay2);ctx.lineTo(ax3,ay3);ctx.stroke();ctx.restore()}
    function updateCounts(){const p=slides.length;const f=slides.filter(s=>!!s.image).length;paraCount.textContent=`Абзацев: ${p}`;photoCount.textContent=`С фото: ${f}/${p}`}
    let t;on(storyInput,'input',()=>{clearTimeout(t);t=setTimeout(async()=>{buildOrPreserve();await renderAll()},500)});
    on(updateBtn,'click',async()=>{buildOrPreserve();await renderAll()});
    on(clearBtn,'click',()=>{results.innerHTML='';slides=[];updateCounts();window.scrollTo({top:0,behavior:'smooth'})});
    window.igApp={destroy(){destroyFns.forEach(f=>f());},filePicker};
    buildOrPreserve();updateCounts();
  })();
  </script>
</body>
</html>
